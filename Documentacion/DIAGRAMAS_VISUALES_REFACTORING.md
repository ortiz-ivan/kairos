# ğŸ¨ Diagramas Visuales - RefactorizaciÃ³n

## Flujo de Datos Completo

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    AGREGAR VENTA - FLUJO COMPLETO               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£  ENTRADA DE USUARIO                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  Escanear CÃ³digoâ”‚              â”‚ Click "Buscar"   â”‚          â”‚
â”‚   â”‚   o Escribir    â”‚              â”‚  (Modal)         â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚            â”‚                                â”‚                    â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                             â”‚                                    â”‚
â”‚                             â†“                                    â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                   â”‚  input#codigo    â”‚                           â”‚
â”‚                   â”‚  input#buscar    â”‚                           â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£  BÃšSQUEDA (ProductSearchManager)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Input "cÃ³digo"              Input "nombre" (Modal)             â”‚
â”‚       â”‚                               â”‚                          â”‚
â”‚       â”œâ”€â†’ handleAutocomplete()       â”œâ”€â†’ handleSearch()         â”‚
â”‚       â”‚   (Debounce 300ms)           â”‚   (Debounce 300ms)       â”‚
â”‚       â”‚                               â”‚                          â”‚
â”‚       â”œâ”€â†’ Fetch /inventario/sugerencias                         â”‚
â”‚       â”‚   Llena <datalist>           â”œâ”€â†’ Fetch /ventas/productos
â”‚       â”‚                               â”‚   Llena tabla            â”‚
â”‚       â”‚                               â”‚                          â”‚
â”‚       â”œâ”€â†’ User presiona Enter        â”œâ”€â†’ User hace click        â”‚
â”‚       â”‚   searchAndSelect()          â”‚   addFromModal()         â”‚
â”‚       â”‚                               â”‚                          â”‚
â”‚       â””â”€â†’ Fetch /ventas/buscar/...   â””â”€â†’ Fetch /productos/...  â”‚
â”‚           Valida stock > 0               Valida stock > 0       â”‚
â”‚           Dispara productSelected       Dispara productSelected â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ğŸ¤ EVENTO: productSelected                             â”‚   â”‚
â”‚   â”‚  detail: { producto: {...} }                            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£  AGREGAR A TABLA (SalesTableManager escucha productSelected) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   addProduct(producto)                                          â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â†’ Â¿Producto existe en tabla?                           â”‚
â”‚       â”‚   â”‚                                                    â”‚
â”‚       â”‚   â”œâ”€ SÃ: incrementar cantidad                          â”‚
â”‚       â”‚   â”‚   â””â”€ Validar: cantidad â‰¤ stock                    â”‚
â”‚       â”‚   â”‚                                                    â”‚
â”‚       â”‚   â””â”€ NO: crear fila en tabla                           â”‚
â”‚       â”‚       â”œâ”€ <tr id="fila_{id}">                          â”‚
â”‚       â”‚       â”œâ”€ CÃ³digo, Nombre, Precio                       â”‚
â”‚       â”‚       â”œâ”€ Input cantidad con validaciÃ³n                â”‚
â”‚       â”‚       â”œâ”€ Subtotal                                     â”‚
â”‚       â”‚       â””â”€ BotÃ³n eliminar                               â”‚
â”‚       â”‚                                                        â”‚
â”‚       â””â”€â†’ updateSubtotal(id)                                   â”‚
â”‚           â””â”€ Calcula: precio Ã— cantidad                        â”‚
â”‚               â””â”€ Dispara tableUpdated                          â”‚
â”‚                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ğŸ¤ EVENTO: tableUpdated                                â”‚   â”‚
â”‚   â”‚  detail: {                                              â”‚   â”‚
â”‚   â”‚    total: 6250000,                                      â”‚   â”‚
â”‚   â”‚    items: 3,                                            â”‚   â”‚
â”‚   â”‚    productosSinStock: 0,                                â”‚   â”‚
â”‚   â”‚    errores: 0,                                          â”‚   â”‚
â”‚   â”‚    hasProducts: true                                    â”‚   â”‚
â”‚   â”‚  }                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ï¸âƒ£  ACTUALIZAR RESUMEN (SummaryPanelManager escucha tableUpdate) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   updateDisplay(data)                                           â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â†’ Total: â‚²6.250.000                                    â”‚
â”‚       â”‚   (Formateado con separadores de miles)                â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â†’ Total en letras:                                     â”‚
â”‚       â”‚   "seis millones doscientos cincuenta mil guaranÃ­es"   â”‚
â”‚       â”‚   (Usando numberToSpanish())                           â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â†’ Items: 3                                             â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â†’ Productos sin stock: 0                               â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â†’ Errores: 0                                           â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â†’ Estado botÃ³n:                                        â”‚
â”‚           â”œâ”€ Si hasProducts && errores === 0: ENABLED         â”‚
â”‚           â””â”€ Si NO: DISABLED                                  â”‚
â”‚                                                                â”‚
â”‚   Panel POS Sticky (derecha):                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚  TOTAL A PAGAR                 â”‚                          â”‚
â”‚   â”‚  â‚² 6.250.000                   â”‚                          â”‚
â”‚   â”‚                                â”‚                          â”‚
â”‚   â”‚  seis millones...guaranÃ­es     â”‚                          â”‚
â”‚   â”‚                                â”‚                          â”‚
â”‚   â”‚  Ãtems: 3                      â”‚                          â”‚
â”‚   â”‚                                â”‚                          â”‚
â”‚   â”‚  [âœ“ Registrar Venta]           â”‚                          â”‚
â”‚   â”‚                                â”‚                          â”‚
â”‚   â”‚  Sin stock: 0                  â”‚                          â”‚
â”‚   â”‚  Errores: 0                    â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â””â”€â†’ ğŸ”„ CICLO REPETIDO
                           Si user:
                           â€¢ Cambia cantidad â†’ tableUpdated
                           â€¢ Elimina producto â†’ tableUpdated
                           â€¢ Agrega otro producto â†’ productSelected
                                              â†“
                                        tableUpdated
```

---

## ComparaciÃ³n: Antes vs DespuÃ©s

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         ANTES (MonolÃ­tico)                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                        â•‘
â•‘   agregar_venta.html (684 lÃ­neas)                                     â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â•‘
â•‘   â”‚ <!DOCTYPE html>                                            â”‚      â•‘
â•‘   â”‚ <html>                                                     â”‚      â•‘
â•‘   â”‚   <head>...</head>                                         â”‚      â•‘
â•‘   â”‚   <body>                                                   â”‚      â•‘
â•‘   â”‚     <div class="container">                                â”‚      â•‘
â•‘   â”‚       <form id="form_venta">                               â”‚      â•‘
â•‘   â”‚         <input id="codigo_barras">                         â”‚      â•‘
â•‘   â”‚         <table id="tabla_productos">                       â”‚      â•‘
â•‘   â”‚           <tbody><!-- Poblado por JS --></tbody>          â”‚      â•‘
â•‘   â”‚         </table>                                           â”‚      â•‘
â•‘   â”‚         <div id="resumen"><!-- Totales --></div>           â”‚      â•‘
â•‘   â”‚       </form>                                              â”‚      â•‘
â•‘   â”‚     </div>                                                 â”‚      â•‘
â•‘   â”‚                                                            â”‚      â•‘
â•‘   â”‚     <script>                                               â”‚      â•‘
â•‘   â”‚       // TODO el cÃ³digo JavaScript aquÃ­                    â”‚      â•‘
â•‘   â”‚       // 684 lÃ­neas sin separaciÃ³n                         â”‚      â•‘
â•‘   â”‚       let productosAgregados = {};                         â”‚      â•‘
â•‘   â”‚       let productoPreview = null;                          â”‚      â•‘
â•‘   â”‚       // ... 600+ lÃ­neas de lÃ³gica mezclada ...            â”‚      â•‘
â•‘   â”‚     </script>                                              â”‚      â•‘
â•‘   â”‚   </body>                                                  â”‚      â•‘
â•‘   â”‚ </html>                                                    â”‚      â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â•‘
â•‘                                                                        â•‘
â•‘   âš ï¸ PROBLEMAS:                                                       â•‘
â•‘      â€¢ DifÃ­cil de entender                                            â•‘
â•‘      â€¢ Imposible de testear                                           â•‘
â•‘      â€¢ No es reutilizable                                             â•‘
â•‘      â€¢ Un cambio afecta todo                                          â•‘
â•‘      â€¢ Debugging es una pesadilla                                     â•‘
â•‘                                                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         DESPUÃ‰S (Modular)                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                        â•‘
â•‘   agregar_venta.html (45 lÃ­neas)                                      â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â•‘
â•‘   â”‚ {% extends "base.html" %}                                  â”‚      â•‘
â•‘   â”‚ {% import "macros_ventas.html" as ventas %}                â”‚      â•‘
â•‘   â”‚                                                            â”‚      â•‘
â•‘   â”‚ {% block content %}                                        â”‚      â•‘
â•‘   â”‚ <div class="container">                                    â”‚      â•‘
â•‘   â”‚   <div class="card">                                       â”‚      â•‘
â•‘   â”‚     {{ ventas.flash_messages() }}                          â”‚      â•‘
â•‘   â”‚     {{ ventas.barcode_input() }}                           â”‚      â•‘
â•‘   â”‚     <form id="form_venta">                                 â”‚      â•‘
â•‘   â”‚       <div class="row">                                    â”‚      â•‘
â•‘   â”‚         <div class="col-md-8">                             â”‚      â•‘
â•‘   â”‚           {{ ventas.products_table() }}                    â”‚      â•‘
â•‘   â”‚         </div>                                             â”‚      â•‘
â•‘   â”‚         <div class="col-md-4">                             â”‚      â•‘
â•‘   â”‚           {{ ventas.summary_panel() }}                     â”‚      â•‘
â•‘   â”‚         </div>                                             â”‚      â•‘
â•‘   â”‚       </div>                                               â”‚      â•‘
â•‘   â”‚     </form>                                                â”‚      â•‘
â•‘   â”‚   </div>                                                   â”‚      â•‘
â•‘   â”‚ </div>                                                     â”‚      â•‘
â•‘   â”‚ {{ ventas.search_modal() }}                                â”‚      â•‘
â•‘   â”‚                                                            â”‚      â•‘
â•‘   â”‚ <script src="product-search.js"></script>                  â”‚      â•‘
â•‘   â”‚ <script src="sales-table.js"></script>                     â”‚      â•‘
â•‘   â”‚ <script src="summary-panel.js"></script>                   â”‚      â•‘
â•‘   â”‚ <script src="search-modal.js"></script>                    â”‚      â•‘
â•‘   â”‚ {% endblock %}                                             â”‚      â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â•‘
â•‘                                                                        â•‘
â•‘   + macros_ventas.html (130 lÃ­neas)                                   â•‘
â•‘     â”œâ”€ product_preview()                                              â•‘
â•‘     â”œâ”€ barcode_input()                                                â•‘
â•‘     â”œâ”€ products_table()                                               â•‘
â•‘     â”œâ”€ summary_panel()                                                â•‘
â•‘     â”œâ”€ search_modal()                                                 â•‘
â•‘     â””â”€ flash_messages()                                               â•‘
â•‘                                                                        â•‘
â•‘   + static/js/product-search.js (100 lÃ­neas)                          â•‘
â•‘     â””â”€ class ProductSearchManager { ... }                             â•‘
â•‘                                                                        â•‘
â•‘   + static/js/sales-table.js (140 lÃ­neas)                             â•‘
â•‘     â””â”€ class SalesTableManager { ... }                                â•‘
â•‘                                                                        â•‘
â•‘   + static/js/summary-panel.js (90 lÃ­neas)                            â•‘
â•‘     â””â”€ class SummaryPanelManager { ... }                              â•‘
â•‘                                                                        â•‘
â•‘   + static/js/search-modal.js (150 lÃ­neas)                            â•‘
â•‘     â””â”€ class ProductSearchModalManager { ... }                        â•‘
â•‘                                                                        â•‘
â•‘   âœ… BENEFICIOS:                                                      â•‘
â•‘      â€¢ CÃ³digo limpio y legible                                        â•‘
â•‘      â€¢ FÃ¡cil de testear (cada mÃ³dulo)                                 â•‘
â•‘      â€¢ Reutilizable en otras pÃ¡ginas                                  â•‘
â•‘      â€¢ Cambios aislados sin afectar otros                             â•‘
â•‘      â€¢ Debugging simple (console.log por mÃ³dulo)                      â•‘
â•‘                                                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ComunicaciÃ³n Entre MÃ³dulos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ARQUITECTURA DE EVENTOS                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                  Evento: 'productSelected'
                  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        â”‚                      â”‚
    â†“                        â†“                      â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProductSearch  â”‚  â”‚  SalesTable     â”‚  â”‚  SearchModal     â”‚
â”‚   Manager       â”‚  â”‚  Manager        â”‚  â”‚  Manager         â”‚
â”‚                 â”‚  â”‚  (escucha)      â”‚  â”‚  (emite)         â”‚
â”‚ Emite evento    â”‚  â”‚                 â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â”‚                    â†“                    â”‚
         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ TABLA ACTUALIZADAâ”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                   Evento: 'tableUpdated'
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                â”‚
                    â†“                â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Summary      â”‚  â”‚ Otro mÃ³dulo      â”‚
              â”‚ Panel Mgr    â”‚  â”‚ (extensible)     â”‚
              â”‚ (escucha)    â”‚  â”‚ (escucha)        â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  FLUJO TÃPICO:

  1. User escanea cÃ³digo
         â†“
  2. ProductSearchManager dispara 'productSelected'
         â†“
  3. SalesTableManager escucha y agrega a tabla
         â†“
  4. SalesTableManager dispara 'tableUpdated'
         â†“
  5. SummaryPanelManager escucha y actualiza totales
         â†“
  6. User ve cambios en tiempo real
```

---

## Complejidad: Antes vs DespuÃ©s

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    COMPLEJIDAD CICLOMÃTICA                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                     â•‘
â•‘  ANTES: FunciÃ³n handleKeyPress (cÃ³digo monolÃ­tico)                â”‚
â•‘                                                                     â•‘
â•‘    function handleKeyPress(e) {
â•‘      if (e.key === "Enter") {              â”
â•‘        if (!codigo) {                       â”‚
â•‘          if (productosAgregados[id]) {      â”‚
â•‘            if (prod.cantidad < stock) {     â”œâ”€â†’ Complejidad: 8+
â•‘              for (id in productosAgregados) â”‚
â•‘                if (!prod.stock || ...) {    â”‚
â•‘                  if (!prod.cantidad || ...) â”‚
â•‘                    ...                      â”‚
â•‘                }                            â”˜
â•‘            }
â•‘          }
â•‘        }
â•‘      }
â•‘    }
â•‘
â•‘    âš ï¸ Complejidad: 8+ (muy alta)
â•‘    âš ï¸ Imposible de testear una rama
â•‘    âš ï¸ Un bug afecta mÃºltiples funcionalidades
â•‘
â•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â•‘
â•‘  DESPUÃ‰S: MÃ©todos pequeÃ±os y enfocados
â•‘
â•‘    // ProductSearchManager
â•‘    async searchAndSelect() {           â”
â•‘      const codigo = input.value;       â”‚ Complejidad: 3
â•‘      if (!codigo) this.showError();    â”œâ”€â†’ (simple, legible)
â•‘      else this.dispatchProductSelected();
â•‘    }                                   â”˜
â•‘
â•‘    // SalesTableManager
â•‘    addProduct(producto) {              â”
â•‘      if (this.exists(id)) {            â”‚ Complejidad: 2
â•‘        this.incrementQuantity();       â”œâ”€â†’ (muy simple)
â•‘      } else {                          â”‚
â•‘        this.createRow();               â”‚
â•‘      }                                 â”˜
â•‘    }
â•‘
â•‘    âœ… Complejidad: 2-3 por mÃ©todo
â•‘    âœ… FÃ¡cil de testear cada rama
â•‘    âœ… Un bug afecta solo a ese mÃ©todo
â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Dependencias

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    GRAFO DE DEPENDENCIAS                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                     â•‘
â•‘  ANTES: Altamente acoplado                                         â•‘
â•‘                                                                     â•‘
â•‘         handleKeyPress()                                           â•‘
â•‘              â”‚                                                     â•‘
â•‘              â”œâ”€â”€â†’ productosAgregados (global)                      â•‘
â•‘              â”œâ”€â”€â†’ tablaBody (DOM)                                  â•‘
â•‘              â”œâ”€â”€â†’ mensajeError (DOM)                               â•‘
â•‘              â”œâ”€â”€â†’ previewProducto (DOM)                            â•‘
â•‘              â”œâ”€â”€â†’ updateSubtotal()                                 â•‘
â•‘              â”‚    â”œâ”€â”€â†’ recalcularTotal()                           â•‘
â•‘              â”‚    â”‚    â”œâ”€â”€â†’ totalItemsCount (DOM)                  â•‘
â•‘              â”‚    â”‚    â”œâ”€â”€â†’ productosSinStockEl (DOM)              â•‘
â•‘              â”‚    â”‚    â”œâ”€â”€â†’ convertirALetras()                     â•‘
â•‘              â”‚    â”‚    â””â”€â”€â†’ totalDisplay (DOM)                     â•‘
â•‘              â”‚    â””â”€â”€â†’ subtotal_X (DOM)                            â•‘
â•‘              â”œâ”€â”€â†’ handleChange() (listener)                        â•‘
â•‘              â”œâ”€â”€â†’ handleDelete() (listener)                        â•‘
â•‘              â””â”€â”€â†’ ... y muchas mÃ¡s ...                             â•‘
â•‘                                                                     â•‘
â•‘  âš ï¸ Cada funciÃ³n depende de mÃºltiples fuentes                     â•‘
â•‘  âš ï¸ Variables globales compartidas                                â•‘
â•‘  âš ï¸ DifÃ­cil aislar para testing                                   â•‘
â•‘                                                                     â•‘
â•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â•‘
â•‘  DESPUÃ‰S: Bajo acoplamiento, alta cohesiÃ³n
â•‘
â•‘  ProductSearchManager (encapsulado)
â•‘      â””â”€â”€ Depende solo de: input, datalist, error container
â•‘
â•‘  SalesTableManager (encapsulado)
â•‘      â”œâ”€â”€ Depende de: form, tbody, error container
â•‘      â”œâ”€â”€ Escucha: productSelected
â•‘      â””â”€â”€ Emite: tableUpdated
â•‘
â•‘  SummaryPanelManager (encapsulado)
â•‘      â”œâ”€â”€ Depende de: total_display, items_count, etc.
â•‘      â””â”€â”€ Escucha: tableUpdated
â•‘
â•‘  SearchModalManager (encapsulado)
â•‘      â”œâ”€â”€ Depende de: modal, search input, results table
â•‘      â””â”€â”€ Emite: productSelected
â•‘
â•‘  ComunicaciÃ³n: Solo por eventos personalizados
â•‘                (productSelected, tableUpdated)
â•‘
â•‘  âœ… Cada mÃ³dulo es independiente                                  â•‘
â•‘  âœ… ComunicaciÃ³n desacoplada                                      â•‘
â•‘  âœ… FÃ¡cil de testear aisladamente                                 â•‘
â•‘  âœ… FÃ¡cil de reutilizar                                           â•‘
â•‘                                                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

**Fin de diagramas visuales** ğŸ‰
