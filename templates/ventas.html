{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="mb-0">Registros de Ventas</h2>
            <small class="text-muted">{{ ventas|length }} de {{ ventas_total|length }} ventas</small>
        </div>
    </div>

    <!-- Resumen de Estadísticas del Día -->
    <div class="row mb-4 g-3">
        <!-- Cantidad de ventas hoy -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small class="opacity-75">Ventas Hoy</small>
                            <h4 class="mb-0 mt-2">{{ estadisticas.cantidad_ventas_hoy }}</h4>
                        </div>
                        <i class="bi bi-graph-up" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total recaudado hoy -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small class="opacity-75">Total Hoy</small>
                            <h4 class="mb-0 mt-2">₲{{ '{:,.0f}'.format(estadisticas.total_recaudado_hoy) }}</h4>
                        </div>
                        <i class="bi bi-currency-dollar" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Venta más grande hoy -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small class="opacity-75">Venta Mayor</small>
                            <h4 class="mb-0 mt-2">₲{{ '{:,.0f}'.format(estadisticas.venta_mas_grande_hoy) }}</h4>
                        </div>
                        <i class="bi bi-trophy" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Promedio por venta hoy -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small class="opacity-75">Promedio</small>
                            <h4 class="mb-0 mt-2">₲{{ '{:,.0f}'.format(estadisticas.promedio_por_venta_hoy) }}</h4>
                        </div>
                        <i class="bi bi-calculator" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros y Búsqueda -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros y Búsqueda</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3" id="filtrosForm">
                <!-- Búsqueda General -->
                <div class="col-md-12">
                    <label for="search" class="form-label"><i class="bi bi-search"></i> Búsqueda (ID, Usuario, Producto)</label>
                    <input
                        type="text"
                        id="search"
                        name="search"
                        class="form-control"
                        placeholder="Ej: 1, admin, Arroz..."
                        value="{{ search_query }}"
                    >
                </div>

                <!-- Filtros en Filas -->
                <div class="col-md-6">
                    <label for="usuario" class="form-label"><i class="bi bi-person"></i> Filtrar por Usuario</label>
                    <select id="usuario" name="usuario" class="form-select">
                        <option value="">-- Todos los usuarios --</option>
                        {% for usuario in usuarios_unicos %}
                        <option value="{{ usuario }}" {% if usuario_filtro == usuario %}selected{% endif %}>
                            {{ usuario }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="monto_minimo" class="form-label"><i class="bi bi-currency-dollar"></i> Monto Mínimo (₲)</label>
                    <input
                        type="number"
                        id="monto_minimo"
                        name="monto_minimo"
                        class="form-control"
                        placeholder="Ej: 100000"
                        value="{{ monto_minimo }}"
                        min="0"
                    >
                </div>

                <div class="col-md-6">
                    <label for="fecha_desde" class="form-label"><i class="bi bi-calendar-event"></i> Desde</label>
                    <input
                        type="date"
                        id="fecha_desde"
                        name="fecha_desde"
                        class="form-control"
                        value="{{ fecha_desde }}"
                    >
                </div>

                <div class="col-md-6">
                    <label for="fecha_hasta" class="form-label"><i class="bi bi-calendar-event"></i> Hasta</label>
                    <input
                        type="date"
                        id="fecha_hasta"
                        name="fecha_hasta"
                        class="form-control"
                        value="{{ fecha_hasta }}"
                    >
                </div>

                <!-- Botones de Acción -->
                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Aplicar Filtros
                    </button>
                    <a href="{{ url_for('registros.listado_registros') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i> Limpiar Filtros
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Información de Resultados -->
    {% if search_query or usuario_filtro or fecha_desde or fecha_hasta or monto_minimo %}
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle"></i> Se muestran <strong>{{ ventas|length }}</strong> venta(s) de <strong>{{ ventas_total|length }}</strong> total(es)
        {% if search_query %}<br><small>• Búsqueda: "{{ search_query }}"</small>{% endif %}
        {% if usuario_filtro %}<br><small>• Usuario: {{ usuario_filtro }}</small>{% endif %}
        {% if monto_minimo %}<br><small>• Monto mínimo: ₲{{ monto_minimo }}</small>{% endif %}
        {% if fecha_desde %}<br><small>• Desde: {{ fecha_desde }}</small>{% endif %}
        {% if fecha_hasta %}<br><small>• Hasta: {{ fecha_hasta }}</small>{% endif %}
    </div>
    {% endif %}

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Total (₲)</th>
                    <th>Productos</th>
                </tr>
            </thead>
            <tbody>
                {% if ventas %}
                {% for venta in ventas %}
                <tr>
                    <td><strong>#{{ venta["id"] }}</strong></td>
                    <td>
                        <small>{{ venta["fecha"] }}</small>
                    </td>
                    <td>{{ venta["username"] if venta["username"] else "-" }}</td>
                    <td>
                        <span class="badge {% if venta["total"] >= 1000000 %}bg-success{% elif venta["total"] >= 500000 %}bg-info{% else %}bg-secondary{% endif %}">
                            ₲{{ venta["total"]|int }}
                        </span>
                    </td>
                    <td>
                        <!-- Botón que abre modal con detalle de productos -->
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#modal-productos-{{ venta["id"] }}">
                            Ver Productos
                        </button>

                        <!-- Modal por venta -->
                        <div class="modal fade" id="modal-productos-{{ venta["id"] }}" tabindex="-1" aria-labelledby="modalLabel-{{ venta["id"] }}" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="modalLabel-{{ venta["id"] }}">Detalle de Venta #{{ venta["id"] }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-borderless mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Producto</th>
                                                        <th class="text-center">Cantidad</th>
                                                        <th class="text-end">Subtotal (₲)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for detalle in obtener_detalle_venta(venta["id"]) %}
                                                    <tr>
                                                        <td>{{ detalle["nombre"] }}</td>
                                                        <td class="text-center">{{ detalle["cantidad"] }}</td>
                                                        <td class="text-end">₲{{ detalle["subtotal"]|int }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2">No se encontraron ventas que coincidan con los filtros aplicados.</p>
                    </td>
                </tr>
                {% endif %}
            </tbody>
                </table>
        </div>

        <!-- Paginación -->
        {% if total_pages and total_pages > 1 %}
        <nav aria-label="Paginación">
            <ul class="pagination justify-content-center mt-3">
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('registros.listado_registros') }}{% if query_string %}?{{ query_string }}&page={{ page-1 }}{% else %}?page={{ page-1 }}{% endif %}">Anterior</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                {% endif %}

                {% for p in range(1, total_pages+1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('registros.listado_registros') }}{% if query_string %}?{{ query_string }}&page={{ p }}{% else %}?page={{ p }}{% endif %}">{{ p }}</a>
                </li>
                {% endfor %}

                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('registros.listado_registros') }}{% if query_string %}?{{ query_string }}&page={{ page+1 }}{% else %}?page={{ page+1 }}{% endif %}">Siguiente</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const formulario = document.getElementById("filtrosForm");
    formulario.addEventListener("submit", function(e) {
        const fechaDesde = document.getElementById("fecha_desde").value;
        const fechaHasta = document.getElementById("fecha_hasta").value;
        if (fechaDesde && fechaHasta) {
            if (new Date(fechaDesde) > new Date(fechaHasta)) {
                e.preventDefault();
                alert("La fecha Desde no puede ser posterior a la fecha Hasta");
                return false;
            }
        }
        const monto = document.getElementById("monto_minimo").value;
        if (monto && parseFloat(monto) < 0) {
            e.preventDefault();
            alert("El monto debe ser positivo");
            return false;
        }
    });
});
</script>
{% endblock %}
