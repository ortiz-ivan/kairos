{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="mb-0">Registros de Ventas</h2>
            <small class="text-muted">{{ ventas|length }} de {{ ventas_total|length }} ventas</small>
        </div>
    </div>

    <!-- Filtros y Búsqueda -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros y Búsqueda</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3" id="filtrosForm">
                <!-- Búsqueda General -->
                <div class="col-md-12">
                    <label for="search" class="form-label"><i class="bi bi-search"></i> Búsqueda (ID, Usuario, Producto)</label>
                    <input
                        type="text"
                        id="search"
                        name="search"
                        class="form-control"
                        placeholder="Ej: 1, admin, Arroz..."
                        value="{{ search_query }}"
                    >
                </div>

                <!-- Filtros en Filas -->
                <div class="col-md-6">
                    <label for="usuario" class="form-label"><i class="bi bi-person"></i> Filtrar por Usuario</label>
                    <select id="usuario" name="usuario" class="form-select">
                        <option value="">-- Todos los usuarios --</option>
                        {% for usuario in usuarios_unicos %}
                        <option value="{{ usuario }}" {% if usuario_filtro == usuario %}selected{% endif %}>
                            {{ usuario }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="monto_minimo" class="form-label"><i class="bi bi-currency-dollar"></i> Monto Mínimo (₲)</label>
                    <input
                        type="number"
                        id="monto_minimo"
                        name="monto_minimo"
                        class="form-control"
                        placeholder="Ej: 100000"
                        value="{{ monto_minimo }}"
                        min="0"
                    >
                </div>

                <div class="col-md-6">
                    <label for="fecha_desde" class="form-label"><i class="bi bi-calendar-event"></i> Desde</label>
                    <input
                        type="date"
                        id="fecha_desde"
                        name="fecha_desde"
                        class="form-control"
                        value="{{ fecha_desde }}"
                    >
                </div>

                <div class="col-md-6">
                    <label for="fecha_hasta" class="form-label"><i class="bi bi-calendar-event"></i> Hasta</label>
                    <input
                        type="date"
                        id="fecha_hasta"
                        name="fecha_hasta"
                        class="form-control"
                        value="{{ fecha_hasta }}"
                    >
                </div>

                <!-- Botones de Acción -->
                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Aplicar Filtros
                    </button>
                    <a href="{{ url_for('ventas.listado_ventas') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i> Limpiar Filtros
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Información de Resultados -->
    {% if search_query or usuario_filtro or fecha_desde or fecha_hasta or monto_minimo %}
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle"></i> Se muestran <strong>{{ ventas|length }}</strong> venta(s) de <strong>{{ ventas_total|length }}</strong> total(es)
        {% if search_query %}<br><small>• Búsqueda: "{{ search_query }}"</small>{% endif %}
        {% if usuario_filtro %}<br><small>• Usuario: {{ usuario_filtro }}</small>{% endif %}
        {% if monto_minimo %}<br><small>• Monto mínimo: ₲{{ monto_minimo }}</small>{% endif %}
        {% if fecha_desde %}<br><small>• Desde: {{ fecha_desde }}</small>{% endif %}
        {% if fecha_hasta %}<br><small>• Hasta: {{ fecha_hasta }}</small>{% endif %}
    </div>
    {% endif %}

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Total (₲)</th>
                    <th>Productos</th>
                </tr>
            </thead>
            <tbody>
                {% if ventas %}
                {% for venta in ventas %}
                <tr>
                    <td><strong>#{{ venta["id"] }}</strong></td>
                    <td>
                        <small>{{ venta["fecha"] }}</small>
                    </td>
                    <td>{{ venta["username"] if venta["username"] else "-" }}</td>
                    <td>
                        <span class="badge {% if venta["total"] >= 1000000 %}bg-success{% elif venta["total"] >= 500000 %}bg-info{% else %}bg-secondary{% endif %}">
                            ₲{{ venta["total"]|int }}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#productos-{{ venta["id"] }}" aria-expanded="false" aria-controls="productos-{{ venta["id"] }}">
                            Ver Productos
                        </button>
                        <div class="collapse mt-2" id="productos-{{ venta["id"] }}">
                            <ul class="list-group">
                                {% for detalle in obtener_detalle_venta(venta["id"]) %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ detalle["nombre"] }}</strong><br>
                                        <small class="text-muted">Cantidad: {{ detalle["cantidad"] }}</small>
                                    </div>
                                    <span>₲{{ detalle["subtotal"]|int }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2">No se encontraron ventas que coincidan con los filtros aplicados.</p>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const formulario = document.getElementById("filtrosForm");
    formulario.addEventListener("submit", function(e) {
        const fechaDesde = document.getElementById("fecha_desde").value;
        const fechaHasta = document.getElementById("fecha_hasta").value;
        if (fechaDesde && fechaHasta) {
            if (new Date(fechaDesde) > new Date(fechaHasta)) {
                e.preventDefault();
                alert("La fecha Desde no puede ser posterior a la fecha Hasta");
                return false;
            }
        }
        const monto = document.getElementById("monto_minimo").value;
        if (monto && parseFloat(monto) < 0) {
            e.preventDefault();
            alert("El monto debe ser positivo");
            return false;
        }
    });
});
</script>
{% endblock %}
