<!-- Filtros y Búsqueda -->
<div class="row mb-4 g-3">
    <div class="col-md-12">
        <form method="GET" class="row g-3" id="filtrosForm">
            <!-- Búsqueda General -->
            <div class="col-md-12">
                <label for="search" class="form-label"><i class="bi bi-search"></i> Búsqueda (ID, Usuario, Producto)</label>
                <input
                    type="text"
                    id="search"
                    name="search"
                    class="form-control"
                    placeholder="Ej: 1, admin, Coca Cola..."
                    value="{{ search_query }}"
                >
            </div>

            <!-- Filtros en Filas -->
            <div class="col-md-6">
                <label for="usuario" class="form-label"><i class="bi bi-person"></i> Filtrar por Usuario</label>
                <select id="usuario" name="usuario" class="form-select">
                    <option value="">-- Todos los usuarios --</option>
                    {% for usuario in usuarios_unicos %}
                    <option value="{{ usuario }}" {% if usuario_filtro == usuario %}selected{% endif %}>
                        {{ usuario }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-6">
                <label for="monto_minimo" class="form-label"><i class="bi bi-currency-dollar"></i> Monto Mínimo (₲)</label>
                <input
                    type="number"
                    id="monto_minimo"
                    name="monto_minimo"
                    class="form-control"
                    placeholder="Ej: 100000"
                    value="{{ monto_minimo }}"
                    min="0"
                >
            </div>

            <div class="col-md-6">
                <label for="fecha_desde" class="form-label"><i class="bi bi-calendar-event"></i> Desde</label>
                <input
                    type="date"
                    id="fecha_desde"
                    name="fecha_desde"
                    class="form-control"
                    value="{{ fecha_desde }}"
                >
            </div>

            <div class="col-md-6">
                <label for="fecha_hasta" class="form-label"><i class="bi bi-calendar-event"></i> Hasta</label>
                <input
                    type="date"
                    id="fecha_hasta"
                    name="fecha_hasta"
                    class="form-control"
                    value="{{ fecha_hasta }}"
                >
            </div>

            <!-- Botones de Acción -->
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Aplicar Filtros
                </button>
                <a href="{{ url_for('registros.listado_registros') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> Limpiar Filtros
                </a>
                <button type="button" class="btn btn-success" id="btnExportarCSV">
                    <i class="bi bi-download"></i> Exportar a CSV
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnExportar = document.getElementById('btnExportarCSV');
    const form = document.getElementById('filtrosForm');

    btnExportar.addEventListener('click', async function(e) {
        e.preventDefault();

        // Obtener valores de filtros del formulario
        const filtros = {
            search: document.getElementById('search').value.trim(),
            usuario: document.getElementById('usuario').value.trim(),
            monto_minimo: document.getElementById('monto_minimo').value.trim(),
            fecha_desde: document.getElementById('fecha_desde').value.trim(),
            fecha_hasta: document.getElementById('fecha_hasta').value.trim(),
        };

        try {
            // Deshabilitar botón y mostrar loading
            const originalText = btnExportar.innerHTML;
            btnExportar.disabled = true;
            btnExportar.innerHTML = '<i class="bi bi-hourglass-split"></i> Exportando...';

            // Enviar request al servidor
            const response = await fetch('{{ url_for("registros.exportar_csv") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(filtros),
            });

            if (!response.ok) {
                throw new Error('Error en la exportación');
            }

            // Descargar archivo
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'registros_ventas.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // Restaurar botón
            btnExportar.disabled = false;
            btnExportar.innerHTML = originalText;
        } catch (error) {
            console.error('Error:', error);
            alert('Error al exportar CSV. Por favor intenta nuevamente.');
            btnExportar.disabled = false;
            btnExportar.innerHTML = originalText;
        }
    });
});
</script>
