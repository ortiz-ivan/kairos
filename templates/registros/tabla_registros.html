<!-- Información de Resultados -->
{% if search_query or usuario_filtro or fecha_desde or fecha_hasta or monto_minimo %}
<div class="p-3 mb-4" style="background-color: var(--bg-tertiary); border-radius: var(--radius-md); border-left: 4px solid var(--color-info);">
    <i class="bi bi-info-circle text-info"></i> Se muestran <strong>{{ ventas|length }}</strong> venta(s) de <strong>{{ ventas_total|length }}</strong> total(es)
    {% if search_query %}<br><small>• Búsqueda: "{{ search_query }}"</small>{% endif %}
    {% if usuario_filtro %}<br><small>• Usuario: {{ usuario_filtro }}</small>{% endif %}
    {% if monto_minimo %}<br><small>• Monto mínimo: ₲{{ monto_minimo }}</small>{% endif %}
    {% if fecha_desde %}<br><small>• Desde: {{ fecha_desde }}</small>{% endif %}
    {% if fecha_hasta %}<br><small>• Hasta: {{ fecha_hasta }}</small>{% endif %}
</div>
{% endif %}

<!-- Tabla -->
<div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
        <thead>
            <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Usuario</th>
                <th>Total (₲)</th>
                <th>Productos</th>
            </tr>
        </thead>
        <tbody>
            {% if ventas %}
            {% for venta in ventas %}
            <tr>
                <td><strong class="text-primary">#{{ venta["id"] }}</strong></td>
                <td>
                    <small class="text-secondary">{{ venta["fecha"] }}</small>
                </td>
                <td>{{ venta["username"] if venta["username"] else "-" }}</td>
                <td>
                    <span class="badge {% if venta["total"] >= 1000000 %}bg-success{% elif venta["total"] >= 500000 %}bg-info{% else %}bg-secondary{% endif %}">
                        ₲{{ venta["total"]|int }}
                    </span>
                </td>
                <td>
                    <!-- Botón que abre modal con detalle de productos -->
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#modal-productos-{{ venta["id"] }}">
                        Ver Productos
                    </button>

                    <!-- Modal por venta -->
                    <div class="modal fade" id="modal-productos-{{ venta["id"] }}" tabindex="-1" aria-labelledby="modalLabel-{{ venta["id"] }}" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalLabel-{{ venta["id"] }}">Detalle de Venta #{{ venta["id"] }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-borderless mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Producto</th>
                                                    <th class="text-center">Cantidad</th>
                                                    <th class="text-end">Subtotal (₲)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for detalle in obtener_detalle_venta(venta["id"]) %}
                                                <tr>
                                                    <td>{{ detalle["nombre"] }}</td>
                                                    <td class="text-center">{{ detalle["cantidad"] }}</td>
                                                    <td class="text-end">₲{{ detalle["subtotal"]|int }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mt-2">No se encontraron ventas que coincidan con los filtros aplicados.</p>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Paginación -->
{% if total_pages and total_pages > 1 %}
<nav aria-label="Paginación" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('registros.listado_registros') }}{% if query_string %}?{{ query_string }}&page={{ page-1 }}{% else %}?page={{ page-1 }}{% endif %}">Anterior</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Anterior</span></li>
        {% endif %}

        {% for p in range(1, total_pages+1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('registros.listado_registros') }}{% if query_string %}?{{ query_string }}&page={{ p }}{% else %}?page={{ p }}{% endif %}">{{ p }}</a>
        </li>
        {% endfor %}

        {% if page < total_pages %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('registros.listado_registros') }}{% if query_string %}?{{ query_string }}&page={{ page+1 }}{% else %}?page={{ page+1 }}{% endif %}">Siguiente</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
        {% endif %}
    </ul>
</nav>
{% endif %}
