{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">Ventas Pendientes</h2>

    {% if pendientes and pendientes|length > 0 %}
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Total (₲)</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for p in pendientes %}
                <tr id="pendiente-row-{{ p['id'] }}">
                    <td>{{ p['id'] }}</td>
                    <td>{{ p['fecha'] }}</td>
                    <td>{{ p['usuario_id'] or '-' }}</td>
                    <td>₲{{ '{:,.0f}'.format(p['total']) }}</td>
                    <td>
                        <button type="button" class="btn btn-success btn-sm btn-retomar-pendiente" data-id="{{ p['id'] }}" data-url="{{ url_for('registros.eliminar_pendiente_view', pendiente_id=p['id']) }}">Retomar</button>
                        <button type="button" class="btn btn-info btn-sm btn-toggle-detalles" data-id="{{ p['id'] }}">Ver productos</button>
                        <button type="button" class="btn btn-danger btn-sm btn-delete-pendiente" data-id="{{ p['id'] }}" data-url="{{ url_for('registros.eliminar_pendiente_view', pendiente_id=p['id']) }}">Eliminar</button>
                    </td>
                </tr>
                <tr id="pendiente-details-{{ p['id'] }}" class="d-none">
                    <td colspan="5">
                        <div class="card card-body p-2">
                            <h6>Productos</h6>
                            {% if p.get('detalles') and p['detalles']|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-sm table-borderless mb-0">
                                    <thead>
                                        <tr>
                                            <th>Producto ID</th>
                                            <th>Nombre</th>
                                            <th>Cantidad</th>
                                            <th>Precio (₲)</th>
                                            <th>Subtotal (₲)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for it in p['detalles'] %}
                                        <tr>
                                            <td>{{ it['id'] }}</td>
                                            <td>{{ it['nombre'] }}</td>
                                            <td>{{ it['cantidad'] }}</td>
                                            <td>₲{{ '{:,.0f}'.format(it['precio']) }}</td>
                                            <td>₲{{ '{:,.0f}'.format(it['subtotal']) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-muted">No hay detalles de productos.</div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">No hay ventas pendientes.</div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Toggle detalles
    document.querySelectorAll('.btn-toggle-detalles').forEach(function(btn){
        btn.addEventListener('click', function(){
            var id = this.dataset.id;
            var detailsRow = document.getElementById('pendiente-details-' + id);
            if(detailsRow){
                detailsRow.classList.toggle('d-none');
            }
        });
    });

    // Retomar pendiente (elimina el pendiente y redirige a agregar venta)
    document.querySelectorAll('.btn-retomar-pendiente').forEach(function(btn){
        btn.addEventListener('click', function(){
            var id = this.dataset.id;
            var url = this.dataset.url;

            // Eliminar el pendiente antes de redirigir
            fetch(url, { method: 'POST' })
                .then(function(resp){ return resp.json(); })
                .then(function(data){
                    if(data && data.success){
                        // Remover filas del DOM
                        var row = document.getElementById('pendiente-row-' + id);
                        var details = document.getElementById('pendiente-details-' + id);
                        if(details) details.remove();
                        if(row) row.remove();

                        // Redirigir a agregar venta con pendiente_id
                        window.location.href = "{{ url_for('ventas.agregar_venta_view') }}?pendiente_id=" + id;
                    } else {
                        alert(data && data.mensaje ? data.mensaje : 'Error al retomar el pendiente.');
                    }
                })
                .catch(function(err){
                    console.error(err);
                    alert('Error de red al retomar el pendiente.');
                });
        });
    });

    // Eliminar pendiente via AJAX
    document.querySelectorAll('.btn-delete-pendiente').forEach(function(btn){
        btn.addEventListener('click', function(){
            var id = this.dataset.id;
            var url = this.dataset.url;
            if(!confirm('¿Confirma eliminar el pendiente ID ' + id + '?')){
                return;
            }

            fetch(url, { method: 'POST' })
                .then(function(resp){ return resp.json(); })
                .then(function(data){
                    if(data && data.success){
                        // Remover filas del DOM
                        var row = document.getElementById('pendiente-row-' + id);
                        var details = document.getElementById('pendiente-details-' + id);
                        if(details) details.remove();
                        if(row) row.remove();

                        // Mostrar mensaje de éxito
                        alert('Pendiente eliminado correctamente.');
                    } else {
                        alert(data && data.mensaje ? data.mensaje : 'Error al eliminar el pendiente.');
                    }
                })
                .catch(function(err){
                    console.error(err);
                    alert('Error de red al eliminar el pendiente.');
                });
        });
    });
});
</script>
{% endblock %}
                .then(function(data){
                    if(data && data.success){
                        // Remover filas del DOM
                        var row = document.getElementById('pendiente-row-' + id);
                        var details = document.getElementById('pendiente-details-' + id);
                        if(details) details.remove();
                        if(row) row.remove();
                    } else {
                        alert(data && data.mensaje ? data.mensaje : 'Error al eliminar el pendiente.');
                    }
                })
                .catch(function(err){
                    console.error(err);
                    alert('Error de red al eliminar el pendiente.');
                });
        });
    });
});
</script>
{% endblock %}
