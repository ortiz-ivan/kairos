{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Registrar Venta</h4>
                </div>
                <div class="card-body">

                    <!-- Mensajes flash -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                      {% if messages %}
                        {% for category, message in messages %}
                          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} mt-2">
                            {{ message }}
                          </div>
                        {% endfor %}
                      {% endif %}
                    {% endwith %}

                    <!-- Campo de búsqueda por código de barras con botón de búsqueda visual -->
                    <div class="mb-3">
                        <label for="codigo_barras" class="form-label">Código de Barras</label>
                        <div class="input-group">
                            <input type="text" id="codigo_barras" class="form-control"
                                   placeholder="Escanee o ingrese el código de barras..." list="sugerencias"
                                   autocomplete="off">
                            <button type="button" class="btn btn-primary" id="btnBuscarModal" title="Buscar producto por nombre">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                        </div>
                        <datalist id="sugerencias"></datalist>
                        <small class="form-text text-muted">Presione Enter para agregar por código, o use el botón Buscar para seleccionar por nombre</small>

                        <!-- Tarjeta informativa de vista previa del producto -->
                        <div id="previewProducto" class="card mt-3" style="display: none; border-left: 4px solid #198754; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div class="card-body py-2 px-3">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <small class="text-muted d-block">Producto</small>
                                        <strong id="previewNombre" class="text-dark"></strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted d-block">Precio</small>
                                        <strong id="previewPrecio" class="text-success"></strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted d-block">Stock</small>
                                        <strong id="previewStock" class="text-info"></strong>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted d-block">Categoría</small>
                                        <span id="previewCategoria" class="badge bg-secondary"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="mensaje_error" class="alert alert-danger mt-2" style="display: none; margin-bottom: 0;"></div>
                    </div>

                    <!-- Formulario principal -->
                    <form method="POST" id="form_venta">
                        <input type="hidden" name="productos" id="productos_input">

                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-bordered align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Código</th>
                                        <th>Producto</th>
                                        <th>Precio (₲)</th>
                                        <th>Cantidad</th>
                                        <th>Subtotal (₲)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Productos agregados dinámicamente -->
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                            <h5>Total: <span id="total_venta" class="text-success">₲0</span></h5>
                            <button type="submit" class="btn btn-success btn-lg" id="btnRegistrar">Registrar Venta</button>
                        </div>
                    </form>

                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>Instrucciones:</strong> Escanee o ingrese códigos de barras y presione Enter.
                            Ajuste cantidades según sea necesario. El sistema validará stock automáticamente.
                        </small>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const inputCodigo = document.getElementById("codigo_barras");
    const datalist = document.getElementById("sugerencias");
    const tablaBody = document.querySelector("#form_venta tbody");
    const totalVenta = document.getElementById("total_venta");
    const mensajeError = document.getElementById("mensaje_error");
    const previewProducto = document.getElementById("previewProducto");
    const previewNombre = document.getElementById("previewNombre");
    const previewPrecio = document.getElementById("previewPrecio");
    const previewStock = document.getElementById("previewStock");
    const previewCategoria = document.getElementById("previewCategoria");
    const formVenta = document.getElementById("form_venta");
    const inputProductos = document.getElementById("productos_input");
    const btnRegistrar = formVenta.querySelector("button[type='submit']");

    let productosAgregados = {};
    let productoPreview = null;

    // ---- Autocompletado de códigos ----
    inputCodigo.addEventListener("input", async () => {
        const q = inputCodigo.value.trim();
        if (!q) {
            datalist.innerHTML = "";
            return;
        }

        try {
            const resp = await fetch(`/inventario/sugerencias?q=${q}`);
            const data = await resp.json();
            datalist.innerHTML = "";
            data.forEach(p => {
                const option = document.createElement("option");
                option.value = p.codigo_barras;
                option.text = p.nombre;
                datalist.appendChild(option);
            });
        } catch (err) {
            console.error("Error al buscar sugerencias:", err);
        }
    });

    // ---- Mostrar vista previa al seleccionar del datalist ----
    inputCodigo.addEventListener("change", async () => {
        const codigo = inputCodigo.value.trim();
        if (!codigo) {
            previewProducto.style.display = "none";
            productoPreview = null;
            return;
        }

        try {
            const resp = await fetch(`/ventas/buscar/${encodeURIComponent(codigo)}`);
            const data = await resp.json();

            if (data.success) {
                const p = data.producto;
                productoPreview = p;

                // Actualizar tarjeta de vista previa
                previewNombre.textContent = p.nombre;
                previewPrecio.textContent = `₲${p.precio.toLocaleString()}`;
                previewStock.textContent = `${p.stock} unidad${p.stock !== 1 ? 'es' : ''}`;
                previewCategoria.textContent = p.categoria;

                // Mostrar tarjeta
                previewProducto.style.display = "block";
            } else {
                previewProducto.style.display = "none";
                productoPreview = null;
            }
        } catch (err) {
            console.error("Error al obtener vista previa:", err);
            previewProducto.style.display = "none";
            productoPreview = null;
        }
    });

    // ---- Ocultar vista previa al limpiar el input ----
    inputCodigo.addEventListener("input", () => {
        if (inputCodigo.value.trim() === "") {
            previewProducto.style.display = "none";
            productoPreview = null;
        }
    });

    // ---- Agregar producto al presionar Enter ----
    inputCodigo.addEventListener("keypress", async (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            const codigo = inputCodigo.value.trim();

            // Validación: código no vacío
            if (!codigo) {
                mensajeError.textContent = "Por favor, ingrese un código de barras.";
                mensajeError.style.display = "block";
                return;
            }

            try {
                const resp = await fetch(`/ventas/buscar/${encodeURIComponent(codigo)}`);
                const data = await resp.json();

                if (data.success) {
                    const p = data.producto;

                    // Validación: stock disponible
                    if (p.stock <= 0) {
                        mensajeError.textContent = `'${p.nombre}' no tiene stock disponible.`;
                        mensajeError.style.display = "block";
                        inputCodigo.value = "";
                        return;
                    }

                    if (productosAgregados[p.id]) {
                        // Producto ya agregado: incrementar cantidad
                        const prod = productosAgregados[p.id];
                        if (prod.cantidad < p.stock) {
                            prod.cantidad += 1;
                            document.querySelector(`#cantidad_${p.id}`).value = prod.cantidad;
                            actualizarSubtotal(p.id);
                            mensajeError.style.display = "none";
                        } else {
                            mensajeError.textContent = `No hay suficiente stock para '${p.nombre}'. Disponible: ${p.stock}`;
                            mensajeError.style.display = "block";
                        }
                    } else {
                        // Producto nuevo: agregarlo a la tabla
                        productosAgregados[p.id] = { ...p, cantidad: 1 };
                        const fila = document.createElement("tr");
                        fila.id = `fila_${p.id}`;
                        fila.innerHTML = `
                            <td>${p.codigo_barras}</td>
                            <td>${p.nombre}</td>
                            <td>₲${p.precio.toLocaleString()}</td>
                            <td>
                                <input type="number" name="cantidad_${p.id}" id="cantidad_${p.id}" class="form-control cantidad"
                                       value="1" min="1" max="${p.stock}" required>
                                <small class="form-text text-muted">Máx: ${p.stock} disponibles</small>
                            </td>
                            <td id="subtotal_${p.id}">₲${p.precio.toLocaleString()}</td>
                            <td><button type="button" class="btn btn-danger btn-sm eliminar" data-id="${p.id}" title="Eliminar producto">&times;</button></td>
                        `;
                        tablaBody.appendChild(fila);
                        mensajeError.style.display = "none";
                    }

                    inputCodigo.value = "";
                    inputCodigo.focus();
                    recalcularTotal();
                    actualizarEstadoBoton();
                } else {
                    mensajeError.textContent = data.mensaje || "Producto no encontrado o código inválido.";
                    mensajeError.style.display = "block";
                    inputCodigo.value = "";
                    inputCodigo.focus();
                }
            } catch (err) {
                console.error("Error:", err);
                mensajeError.textContent = "Error al conectar con el servidor. Intente nuevamente.";
                mensajeError.style.display = "block";
            }
        }
    });

    // ---- Cambiar cantidad con validación ----
    tablaBody.addEventListener("input", (e) => {
        if (e.target.classList.contains("cantidad")) {
            const id = parseInt(e.target.id.split("_")[1]);
            let nuevaCantidad = parseInt(e.target.value) || 0;
            const stockDisponible = productosAgregados[id].stock;

            // Validación: cantidad > 0
            if (nuevaCantidad <= 0) {
                e.target.value = 1;
                nuevaCantidad = 1;
            }

            // Validación: no exceder stock
            if (nuevaCantidad > stockDisponible) {
                e.target.classList.add("is-invalid");
                e.target.title = `Stock máximo: ${stockDisponible}`;
                nuevaCantidad = stockDisponible;
                e.target.value = stockDisponible;
            } else {
                e.target.classList.remove("is-invalid");
                e.target.title = "";
            }

            productosAgregados[id].cantidad = nuevaCantidad;
            actualizarSubtotal(id);
        }
    });

    // ---- Eliminar producto ----
    tablaBody.addEventListener("click", (e) => {
        if (e.target.classList.contains("eliminar")) {
            e.preventDefault();
            const id = parseInt(e.target.dataset.id);
            delete productosAgregados[id];
            document.getElementById(`fila_${id}`).remove();
            recalcularTotal();
            actualizarEstadoBoton();
            mensajeError.style.display = "none";
        }
    });

    function actualizarSubtotal(id) {
        const producto = productosAgregados[id];
        const subtotal = producto.precio * producto.cantidad;
        document.getElementById(`subtotal_${id}`).textContent = `₲${subtotal.toLocaleString()}`;
        recalcularTotal();
    }

    function recalcularTotal() {
        let total = 0;
        for (const id in productosAgregados) {
            const prod = productosAgregados[id];
            total += prod.precio * prod.cantidad;
        }
        totalVenta.textContent = `₲${total.toLocaleString()}`;
    }

    function actualizarEstadoBoton() {
        const tieneProductos = Object.keys(productosAgregados).length > 0;
        btnRegistrar.disabled = !tieneProductos;
        btnRegistrar.title = tieneProductos ? "Registrar venta" : "Debe agregar al menos un producto";
    }

    // ---- Validación al enviar formulario ----
    formVenta.addEventListener("submit", (e) => {
        // Validación: al menos un producto
        const cantidadProductos = Object.keys(productosAgregados).length;
        if (cantidadProductos === 0) {
            e.preventDefault();
            mensajeError.textContent = "Debe agregar al menos un producto a la venta.";
            mensajeError.style.display = "block";
            inputCodigo.focus();
            return;
        }

        // Validación: todas las cantidades son válidas
        for (const id in productosAgregados) {
            const prod = productosAgregados[id];
            if (prod.cantidad <= 0 || prod.cantidad > prod.stock) {
                e.preventDefault();
                mensajeError.textContent = `Error en cantidad del producto '${prod.nombre}'. Cantidad debe ser entre 1 y ${prod.stock}.`;
                mensajeError.style.display = "block";
                return;
            }
        }

        // Preparar datos para envío
        const productosFormateados = Object.values(productosAgregados).map(p => ({
            id: p.id,
            cantidad: p.cantidad
        }));

        inputProductos.value = JSON.stringify(productosFormateados);
        mensajeError.style.display = "none";
    });

    // Estado inicial del botón
    actualizarEstadoBoton();
});
</script>

<!-- Modal de Búsqueda de Productos -->
<div class="modal fade" id="modalBuscarProducto" tabindex="-1" aria-labelledby="modalBuscarLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalBuscarLabel">Buscar Producto por Nombre</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" id="inputBuscarProducto" class="form-control form-control-lg"
                           placeholder="Ingrese nombre, código o categoría del producto..." autocomplete="off">
                    <small class="form-text text-muted d-block mt-2">
                        Comience a escribir para ver productos que coincidan...
                    </small>
                </div>

                <!-- Spinner de carga -->
                <div id="spinnerCargando" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                <!-- Tabla de resultados -->
                <div class="table-responsive" id="tablaResultadosContainer" style="display: none;">
                    <table class="table table-hover table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th>Código</th>
                                <th>Categoría</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tablaResultados">
                            <!-- Resultados se cargan aquí -->
                        </tbody>
                    </table>
                </div>

                <!-- Mensaje cuando no hay resultados -->
                <div id="sinResultados" class="alert alert-info" style="display: none;">
                    <i class="bi bi-info-circle"></i> No se encontraron productos que coincidan con la búsqueda.
                </div>

                <!-- Mensaje inicial -->
                <div id="mensajeInicial" class="text-center text-muted">
                    <i class="bi bi-search" style="font-size: 2rem; opacity: 0.5;"></i>
                    <p class="mt-2">Comience a escribir para buscar productos...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Variables para el modal
    const modalBuscar = new bootstrap.Modal(document.getElementById("modalBuscarProducto"));
    const btnBuscarModal = document.getElementById("btnBuscarModal");
    const inputBuscarProducto = document.getElementById("inputBuscarProducto");
    const tablaResultados = document.getElementById("tablaResultados");
    const tablaResultadosContainer = document.getElementById("tablaResultadosContainer");
    const sinResultados = document.getElementById("sinResultados");
    const mensajeInicial = document.getElementById("mensajeInicial");
    const spinnerCargando = document.getElementById("spinnerCargando");
    let timerBusqueda;

    // Abrir modal
    btnBuscarModal.addEventListener("click", () => {
        inputBuscarProducto.value = "";
        tablaResultados.innerHTML = "";
        tablaResultadosContainer.style.display = "none";
        sinResultados.style.display = "none";
        mensajeInicial.style.display = "block";
        spinnerCargando.style.display = "none";
        inputBuscarProducto.focus();
        modalBuscar.show();
    });

    // Búsqueda en tiempo real
    inputBuscarProducto.addEventListener("input", () => {
        clearTimeout(timerBusqueda);
        const q = inputBuscarProducto.value.trim();

        if (q.length < 2) {
            tablaResultados.innerHTML = "";
            tablaResultadosContainer.style.display = "none";
            sinResultados.style.display = "none";
            mensajeInicial.style.display = "block";
            spinnerCargando.style.display = "none";
            return;
        }

        spinnerCargando.style.display = "block";
        mensajeInicial.style.display = "none";

        timerBusqueda = setTimeout(async () => {
            try {
                const response = await fetch(`/ventas/productos/buscar?q=${encodeURIComponent(q)}`);
                const data = await response.json();
                spinnerCargando.style.display = "none";

                if (data.productos && data.productos.length > 0) {
                    tablaResultados.innerHTML = data.productos.map(p => `
                        <tr>
                            <td>
                                <strong>${p.nombre}</strong>
                            </td>
                            <td>
                                <code>${p.codigo_barras}</code>
                            </td>
                            <td>
                                <span class="badge bg-secondary">${p.categoria}</span>
                            </td>
                            <td>
                                <strong>₲${parseInt(p.precio).toLocaleString('es-ES')}</strong>
                            </td>
                            <td>
                                <span class="badge ${p.stock > 0 ? 'bg-success' : 'bg-danger'}">
                                    ${p.stock} ${p.stock === 1 ? 'unidad' : 'unidades'}
                                </span>
                            </td>
                            <td>
                                ${p.stock > 0
                                    ? `<button type="button" class="btn btn-sm btn-success" onclick="agregarProductoDesdeModal(${p.id}, '${p.nombre}', ${p.precio})">
                                        <i class="bi bi-plus-circle"></i> Agregar
                                      </button>`
                                    : `<button type="button" class="btn btn-sm btn-secondary" disabled>
                                        Sin stock
                                      </button>`
                                }
                            </td>
                        </tr>
                    `).join("");
                    tablaResultadosContainer.style.display = "block";
                    sinResultados.style.display = "none";
                    mensajeInicial.style.display = "none";
                } else {
                    tablaResultados.innerHTML = "";
                    tablaResultadosContainer.style.display = "none";
                    sinResultados.style.display = "block";
                    mensajeInicial.style.display = "none";
                }
            } catch (error) {
                console.error("Error en búsqueda:", error);
                spinnerCargando.style.display = "none";
                sinResultados.style.display = "block";
                sinResultados.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error al buscar productos.';
                mensajeInicial.style.display = "none";
            }
        }, 300); // Debounce de 300ms
    });
});

// Función global para agregar producto desde el modal
function agregarProductoDesdeModal(productoId, productoNombre, productioPrecio) {
    const formVenta = document.getElementById("form_venta");
    const tablaBody = document.querySelector("#form_venta tbody");

    // Obtener datos del producto (necesitamos hacer otra búsqueda para obtener stock)
    fetch(`/ventas/productos/buscar?q=${encodeURIComponent(productoNombre)}`)
        .then(response => response.json())
        .then(data => {
            const producto = data.productos.find(p => p.id === productoId);
            if (producto) {
                // Usar la función existente del formulario de ventas
                const existentes = document.querySelectorAll("tbody tr");
                const yaExiste = Array.from(existentes).some(row => {
                    const codigo = row.querySelector("td:first-child")?.textContent.trim();
                    return codigo === producto.codigo_barras;
                });

                if (yaExiste) {
                    alert("Este producto ya está agregado. Ajuste la cantidad en la tabla.");
                    return;
                }

                // Simular agregar el producto
                const event = new KeyboardEvent("keypress", {
                    key: "Enter",
                    code: "Enter",
                    keyCode: 13,
                    which: 13,
                    bubbles: true
                });

                // Llenar el input y disparar evento
                const inputCodigo = document.getElementById("codigo_barras");
                inputCodigo.value = producto.codigo_barras;
                inputCodigo.dispatchEvent(event);

                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById("modalBuscarProducto"));
                if (modal) modal.hide();
            }
        })
        .catch(error => {
            console.error("Error al obtener producto:", error);
            alert("Error al agregar el producto.");
        });
}
</script>
{% endblock %}
