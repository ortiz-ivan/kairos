{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Registrar Venta</h4>
                </div>
                <div class="card-body">

                    <!-- Mensajes flash -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                      {% if messages %}
                        {% for category, message in messages %}
                          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} mt-2">
                            {{ message }}
                          </div>
                        {% endfor %}
                      {% endif %}
                    {% endwith %}

                    <!-- Campo de búsqueda por código de barras con datalist -->
                    <div class="mb-3">
                        <label for="codigo_barras" class="form-label">Código de Barras</label>
                        <input type="text" id="codigo_barras" class="form-control" 
                               placeholder="Escanee o ingrese el código de barras..." list="sugerencias">
                        <datalist id="sugerencias"></datalist>
                        <div id="mensaje_error" class="text-danger mt-2" style="display: none;"></div>
                    </div>

                    <!-- Formulario principal -->
                    <form method="POST" id="form_venta">
                        <input type="hidden" name="productos" id="productos_input">

                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-bordered align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Código</th>
                                        <th>Producto</th>
                                        <th>Precio (₲)</th>
                                        <th>Cantidad</th>
                                        <th>Subtotal (₲)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Productos agregados dinámicamente -->
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                            <h5>Total: <span id="total_venta">₲0</span></h5>
                            <button type="submit" class="btn btn-success btn-lg">Registrar Venta</button>
                        </div>
                    </form>

                    <div class="mt-2">
                        <small class="text-muted">Nota: si un producto excede el stock disponible, no se puede agregar más.</small>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const inputCodigo = document.getElementById("codigo_barras");
    const datalist = document.getElementById("sugerencias");
    const tablaBody = document.querySelector("#form_venta tbody");
    const totalVenta = document.getElementById("total_venta");
    const mensajeError = document.getElementById("mensaje_error");
    const formVenta = document.getElementById("form_venta");
    const inputProductos = document.getElementById("productos_input");

    let productosAgregados = {};

    // ---- Autocompletado de códigos ----
    inputCodigo.addEventListener("input", async () => {
        const q = inputCodigo.value.trim();
        if (!q) {
            datalist.innerHTML = "";
            return;
        }

        try {
            const resp = await fetch(`/inventario/sugerencias?q=${q}`);
            const data = await resp.json();
            datalist.innerHTML = "";
            data.forEach(p => {
                const option = document.createElement("option");
                option.value = p.codigo_barras;
                option.text = p.nombre;
                datalist.appendChild(option);
            });
        } catch (err) {
            console.error("Error al buscar sugerencias:", err);
        }
    });

    // ---- Agregar producto al presionar Enter ----
    inputCodigo.addEventListener("keypress", async (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            const codigo = inputCodigo.value.trim();
            if (!codigo) return;

            try {
                const resp = await fetch(`/ventas/buscar/${codigo}`);
                const data = await resp.json();

                if (data.success) {
                    const p = data.producto;

                    if (productosAgregados[p.id]) {
                        const prod = productosAgregados[p.id];
                        if (prod.cantidad < p.stock) {
                            prod.cantidad += 1;
                            document.querySelector(`#cantidad_${p.id}`).value = prod.cantidad;
                            actualizarSubtotal(p.id);
                        } else {
                            alert("No hay suficiente stock disponible.");
                        }
                    } else {
                        productosAgregados[p.id] = { ...p, cantidad: 1 };
                        const fila = document.createElement("tr");
                        fila.innerHTML = `
                            <td>${p.codigo_barras}</td>
                            <td>${p.nombre}</td>
                            <td>₲${p.precio.toLocaleString()}</td>
                            <td>
                                <input type="number" name="cantidad_${p.id}" id="cantidad_${p.id}" class="form-control cantidad"
                                       value="1" min="1" max="${p.stock}">
                            </td>
                            <td id="subtotal_${p.id}">₲${p.precio.toLocaleString()}</td>
                            <td><button type="button" class="btn btn-danger btn-sm eliminar" data-id="${p.id}">&times;</button></td>
                        `;
                        tablaBody.appendChild(fila);
                    }

                    mensajeError.style.display = "none";
                    inputCodigo.value = "";
                    recalcularTotal();
                } else {
                    mensajeError.textContent = data.mensaje || "Producto no encontrado o código inválido.";
                    mensajeError.style.display = "block";
                }
            } catch (err) {
                mensajeError.textContent = "Error al conectar con el servidor.";
                mensajeError.style.display = "block";
            }
        }
    });

    // ---- Cambiar cantidad ----
    tablaBody.addEventListener("input", (e) => {
        if (e.target.classList.contains("cantidad")) {
            const id = e.target.id.split("_")[1];
            let nuevaCantidad = parseInt(e.target.value) || 0;
            if (nuevaCantidad > productosAgregados[id].stock) {
                alert("No puedes vender más de lo que hay en stock.");
                e.target.value = productosAgregados[id].stock;
                nuevaCantidad = productosAgregados[id].stock;
            }
            productosAgregados[id].cantidad = nuevaCantidad;
            actualizarSubtotal(id);
        }
    });

    // ---- Eliminar producto ----
    tablaBody.addEventListener("click", (e) => {
        if (e.target.classList.contains("eliminar")) {
            const id = e.target.dataset.id;
            delete productosAgregados[id];
            e.target.closest("tr").remove();
            recalcularTotal();
        }
    });

    function actualizarSubtotal(id) {
        const producto = productosAgregados[id];
        const subtotal = producto.precio * producto.cantidad;
        document.getElementById(`subtotal_${id}`).textContent = `₲${subtotal.toLocaleString()}`;
        recalcularTotal();
    }

    function recalcularTotal() {
        let total = 0;
        for (const id in productosAgregados) {
            total += productosAgregados[id].precio * productosAgregados[id].cantidad;
        }
        totalVenta.textContent = `₲${total.toLocaleString()}`;
    }

    // ---- Enviar al backend ----
    formVenta.addEventListener("submit", (e) => {
        if (Object.keys(productosAgregados).length === 0) {
            e.preventDefault();
            alert("No hay productos en la venta.");
            return;
        }

        const productosFormateados = Object.values(productosAgregados).map(p => ({
            id: p.id,
            cantidad: p.cantidad
        }));

        inputProductos.value = JSON.stringify(productosFormateados);
    });
});
</script>
{% endblock %}
