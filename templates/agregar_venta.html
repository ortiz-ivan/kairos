{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Registrar Venta</h4>
                </div>
                <div class="card-body">

                    <!-- Mensajes flash -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                      {% if messages %}
                        {% for category, message in messages %}
                          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} mt-2">
                            {{ message }}
                          </div>
                        {% endfor %}
                      {% endif %}
                    {% endwith %}

                    <!-- Campo de búsqueda por código de barras con datalist -->
                    <div class="mb-3">
                        <label for="codigo_barras" class="form-label">Código de Barras</label>
                        <input type="text" id="codigo_barras" class="form-control"
                               placeholder="Escanee o ingrese el código de barras..." list="sugerencias"
                               autocomplete="off">
                        <datalist id="sugerencias"></datalist>
                        <small class="form-text text-muted">Presione Enter para agregar el producto</small>
                        <div id="mensaje_error" class="alert alert-danger mt-2" style="display: none; margin-bottom: 0;"></div>
                    </div>

                    <!-- Formulario principal -->
                    <form method="POST" id="form_venta">
                        <input type="hidden" name="productos" id="productos_input">

                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-bordered align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Código</th>
                                        <th>Producto</th>
                                        <th>Precio (₲)</th>
                                        <th>Cantidad</th>
                                        <th>Subtotal (₲)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Productos agregados dinámicamente -->
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                            <h5>Total: <span id="total_venta" class="text-success">₲0</span></h5>
                            <button type="submit" class="btn btn-success btn-lg" id="btnRegistrar">Registrar Venta</button>
                        </div>
                    </form>

                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>Instrucciones:</strong> Escanee o ingrese códigos de barras y presione Enter.
                            Ajuste cantidades según sea necesario. El sistema validará stock automáticamente.
                        </small>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const inputCodigo = document.getElementById("codigo_barras");
    const datalist = document.getElementById("sugerencias");
    const tablaBody = document.querySelector("#form_venta tbody");
    const totalVenta = document.getElementById("total_venta");
    const mensajeError = document.getElementById("mensaje_error");
    const formVenta = document.getElementById("form_venta");
    const inputProductos = document.getElementById("productos_input");
    const btnRegistrar = formVenta.querySelector("button[type='submit']");

    let productosAgregados = {};

    // ---- Autocompletado de códigos ----
    inputCodigo.addEventListener("input", async () => {
        const q = inputCodigo.value.trim();
        if (!q) {
            datalist.innerHTML = "";
            return;
        }

        try {
            const resp = await fetch(`/inventario/sugerencias?q=${q}`);
            const data = await resp.json();
            datalist.innerHTML = "";
            data.forEach(p => {
                const option = document.createElement("option");
                option.value = p.codigo_barras;
                option.text = p.nombre;
                datalist.appendChild(option);
            });
        } catch (err) {
            console.error("Error al buscar sugerencias:", err);
        }
    });

    // ---- Agregar producto al presionar Enter ----
    inputCodigo.addEventListener("keypress", async (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            const codigo = inputCodigo.value.trim();

            // Validación: código no vacío
            if (!codigo) {
                mensajeError.textContent = "Por favor, ingrese un código de barras.";
                mensajeError.style.display = "block";
                return;
            }

            try {
                const resp = await fetch(`/ventas/buscar/${encodeURIComponent(codigo)}`);
                const data = await resp.json();

                if (data.success) {
                    const p = data.producto;

                    // Validación: stock disponible
                    if (p.stock <= 0) {
                        mensajeError.textContent = `'${p.nombre}' no tiene stock disponible.`;
                        mensajeError.style.display = "block";
                        inputCodigo.value = "";
                        return;
                    }

                    if (productosAgregados[p.id]) {
                        // Producto ya agregado: incrementar cantidad
                        const prod = productosAgregados[p.id];
                        if (prod.cantidad < p.stock) {
                            prod.cantidad += 1;
                            document.querySelector(`#cantidad_${p.id}`).value = prod.cantidad;
                            actualizarSubtotal(p.id);
                            mensajeError.style.display = "none";
                        } else {
                            mensajeError.textContent = `No hay suficiente stock para '${p.nombre}'. Disponible: ${p.stock}`;
                            mensajeError.style.display = "block";
                        }
                    } else {
                        // Producto nuevo: agregarlo a la tabla
                        productosAgregados[p.id] = { ...p, cantidad: 1 };
                        const fila = document.createElement("tr");
                        fila.id = `fila_${p.id}`;
                        fila.innerHTML = `
                            <td>${p.codigo_barras}</td>
                            <td>${p.nombre}</td>
                            <td>₲${p.precio.toLocaleString()}</td>
                            <td>
                                <input type="number" name="cantidad_${p.id}" id="cantidad_${p.id}" class="form-control cantidad"
                                       value="1" min="1" max="${p.stock}" required>
                                <small class="form-text text-muted">Máx: ${p.stock} disponibles</small>
                            </td>
                            <td id="subtotal_${p.id}">₲${p.precio.toLocaleString()}</td>
                            <td><button type="button" class="btn btn-danger btn-sm eliminar" data-id="${p.id}" title="Eliminar producto">&times;</button></td>
                        `;
                        tablaBody.appendChild(fila);
                        mensajeError.style.display = "none";
                    }

                    inputCodigo.value = "";
                    inputCodigo.focus();
                    recalcularTotal();
                    actualizarEstadoBoton();
                } else {
                    mensajeError.textContent = data.mensaje || "Producto no encontrado o código inválido.";
                    mensajeError.style.display = "block";
                    inputCodigo.value = "";
                    inputCodigo.focus();
                }
            } catch (err) {
                console.error("Error:", err);
                mensajeError.textContent = "Error al conectar con el servidor. Intente nuevamente.";
                mensajeError.style.display = "block";
            }
        }
    });

    // ---- Cambiar cantidad con validación ----
    tablaBody.addEventListener("input", (e) => {
        if (e.target.classList.contains("cantidad")) {
            const id = parseInt(e.target.id.split("_")[1]);
            let nuevaCantidad = parseInt(e.target.value) || 0;
            const stockDisponible = productosAgregados[id].stock;

            // Validación: cantidad > 0
            if (nuevaCantidad <= 0) {
                e.target.value = 1;
                nuevaCantidad = 1;
            }

            // Validación: no exceder stock
            if (nuevaCantidad > stockDisponible) {
                e.target.classList.add("is-invalid");
                e.target.title = `Stock máximo: ${stockDisponible}`;
                nuevaCantidad = stockDisponible;
                e.target.value = stockDisponible;
            } else {
                e.target.classList.remove("is-invalid");
                e.target.title = "";
            }

            productosAgregados[id].cantidad = nuevaCantidad;
            actualizarSubtotal(id);
        }
    });

    // ---- Eliminar producto ----
    tablaBody.addEventListener("click", (e) => {
        if (e.target.classList.contains("eliminar")) {
            e.preventDefault();
            const id = parseInt(e.target.dataset.id);
            delete productosAgregados[id];
            document.getElementById(`fila_${id}`).remove();
            recalcularTotal();
            actualizarEstadoBoton();
            mensajeError.style.display = "none";
        }
    });

    function actualizarSubtotal(id) {
        const producto = productosAgregados[id];
        const subtotal = producto.precio * producto.cantidad;
        document.getElementById(`subtotal_${id}`).textContent = `₲${subtotal.toLocaleString()}`;
        recalcularTotal();
    }

    function recalcularTotal() {
        let total = 0;
        for (const id in productosAgregados) {
            const prod = productosAgregados[id];
            total += prod.precio * prod.cantidad;
        }
        totalVenta.textContent = `₲${total.toLocaleString()}`;
    }

    function actualizarEstadoBoton() {
        const tieneProductos = Object.keys(productosAgregados).length > 0;
        btnRegistrar.disabled = !tieneProductos;
        btnRegistrar.title = tieneProductos ? "Registrar venta" : "Debe agregar al menos un producto";
    }

    // ---- Validación al enviar formulario ----
    formVenta.addEventListener("submit", (e) => {
        // Validación: al menos un producto
        const cantidadProductos = Object.keys(productosAgregados).length;
        if (cantidadProductos === 0) {
            e.preventDefault();
            mensajeError.textContent = "Debe agregar al menos un producto a la venta.";
            mensajeError.style.display = "block";
            inputCodigo.focus();
            return;
        }

        // Validación: todas las cantidades son válidas
        for (const id in productosAgregados) {
            const prod = productosAgregados[id];
            if (prod.cantidad <= 0 || prod.cantidad > prod.stock) {
                e.preventDefault();
                mensajeError.textContent = `Error en cantidad del producto '${prod.nombre}'. Cantidad debe ser entre 1 y ${prod.stock}.`;
                mensajeError.style.display = "block";
                return;
            }
        }

        // Preparar datos para envío
        const productosFormateados = Object.values(productosAgregados).map(p => ({
            id: p.id,
            cantidad: p.cantidad
        }));

        inputProductos.value = JSON.stringify(productosFormateados);
        mensajeError.style.display = "none";
    });

    // Estado inicial del botón
    actualizarEstadoBoton();
});
</script>
{% endblock %}
