{% extends "base.html" %}
{% block title %}Dashboard de Registros{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0"><i class="bi bi-bar-chart-line"></i> Dashboard de Registros</h1>
                    <small class="text-muted">Análisis completo de ventas y tendencias</small>
                </div>
                <div class="text-end">
                    <small class="text-muted d-block">Última actualización</small>
                    <small class="fw-bold">{{ now.strftime("%d/%m/%Y %H:%M") if now else "N/A" }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Generales -->
    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-primary text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-receipt me-2" style="font-size: 1.5rem;"></i>
                            <small class="opacity-75">Total Ventas</small>
                        </div>
                        <h3 class="mb-0">{{ estadisticas_general.total_ventas|int }}</h3>
                        <small class="opacity-75">en {{ estadisticas_general.dias_con_ventas }} días</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-success text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-cash-coin me-2" style="font-size: 1.5rem;"></i>
                            <small class="opacity-75">Total Recaudado</small>
                        </div>
                        <h3 class="mb-0">₲{{ '{:,.0f}'.format(estadisticas_general.total_recaudado) }}</h3>
                        <small class="opacity-75">acumulado</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-info text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-calculator me-2" style="font-size: 1.5rem;"></i>
                            <small class="opacity-75">Venta Promedio</small>
                        </div>
                        <h3 class="mb-0">₲{{ '{:,.0f}'.format(estadisticas_general.venta_promedio) }}</h3>
                        <small class="opacity-75">por transacción</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-warning text-dark h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-trophy me-2" style="font-size: 1.5rem;"></i>
                            <small class="opacity-75">Venta Mayor</small>
                        </div>
                        <h3 class="mb-0">₲{{ '{:,.0f}'.format(estadisticas_general.venta_mas_grande) }}</h3>
                        <small class="opacity-75">máximo histórico</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas del Día -->
    <div class="row mb-4 g-3">
        <div class="col-12">
            <h4 class="mb-3"><i class="bi bi-calendar-day"></i> Resumen de Hoy</h4>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up text-primary" style="font-size: 2rem;"></i>
                    <h5 class="mt-2">{{ estadisticas.cantidad_ventas_hoy }}</h5>
                    <small class="text-muted">Ventas Hoy</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body text-center">
                    <i class="bi bi-currency-dollar text-success" style="font-size: 2rem;"></i>
                    <h5 class="mt-2">₲{{ '{:,.0f}'.format(estadisticas.total_recaudado_hoy) }}</h5>
                    <small class="text-muted">Total Hoy</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body text-center">
                    <i class="bi bi-trophy text-warning" style="font-size: 2rem;"></i>
                    <h5 class="mt-2">₲{{ '{:,.0f}'.format(estadisticas.venta_mas_grande_hoy) }}</h5>
                    <small class="text-muted">Venta Mayor</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body text-center">
                    <i class="bi bi-calculator text-info" style="font-size: 2rem;"></i>
                    <h5 class="mt-2">₲{{ '{:,.0f}'.format(estadisticas.promedio_por_venta_hoy) }}</h5>
                    <small class="text-muted">Promedio</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4 g-4">
        <!-- Ventas por Mes -->
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Tendencia de Ventas por Mes</h5>
                </div>
                <div class="card-body">
                    <canvas id="ventasMensualesChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Productos Más Vendidos -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-star"></i> Productos Más Vendidos</h5>
                </div>
                <div class="card-body">
                    <canvas id="topProductosChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Ventas por Semana -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Ventas por Semana (Últimas 8 semanas)</h5>
                </div>
                <div class="card-body">
                    <canvas id="ventasSemanalesChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Registros -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-table"></i> Registros de Ventas</h5>
                    <small class="opacity-75">{{ ventas|length }} de {{ ventas_total|length }} ventas</small>
                </div>
                <div class="card-body">
                    <!-- Filtros y Búsqueda -->
                    <div class="row mb-4 g-3">
                        <div class="col-md-12">
                            <form method="GET" class="row g-3" id="filtrosForm">
                                <!-- Búsqueda General -->
                                <div class="col-md-12">
                                    <label for="search" class="form-label"><i class="bi bi-search"></i> Búsqueda (ID, Usuario, Producto)</label>
                                    <input
                                        type="text"
                                        id="search"
                                        name="search"
                                        class="form-control"
                                        placeholder="Ej: 1, admin, Arroz..."
                                        value="{{ search_query }}"
                                    >
                                </div>

                                <!-- Filtros en Filas -->
                                <div class="col-md-6">
                                    <label for="usuario" class="form-label"><i class="bi bi-person"></i> Filtrar por Usuario</label>
                                    <select id="usuario" name="usuario" class="form-select">
                                        <option value="">-- Todos los usuarios --</option>
                                        {% for usuario in usuarios_unicos %}
                                        <option value="{{ usuario }}" {% if usuario_filtro == usuario %}selected{% endif %}>
                                            {{ usuario }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label for="monto_minimo" class="form-label"><i class="bi bi-currency-dollar"></i> Monto Mínimo (₲)</label>
                                    <input
                                        type="number"
                                        id="monto_minimo"
                                        name="monto_minimo"
                                        class="form-control"
                                        placeholder="Ej: 100000"
                                        value="{{ monto_minimo }}"
                                        min="0"
                                    >
                                </div>

                                <div class="col-md-6">
                                    <label for="fecha_desde" class="form-label"><i class="bi bi-calendar-event"></i> Desde</label>
                                    <input
                                        type="date"
                                        id="fecha_desde"
                                        name="fecha_desde"
                                        class="form-control"
                                        value="{{ fecha_desde }}"
                                    >
                                </div>

                                <div class="col-md-6">
                                    <label for="fecha_hasta" class="form-label"><i class="bi bi-calendar-event"></i> Hasta</label>
                                    <input
                                        type="date"
                                        id="fecha_hasta"
                                        name="fecha_hasta"
                                        class="form-control"
                                        value="{{ fecha_hasta }}"
                                    >
                                </div>

                                <!-- Botones de Acción -->
                                <div class="col-md-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-search"></i> Aplicar Filtros
                                    </button>
                                    <a href="{{ url_for('registros.listado_registros') }}" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-counterclockwise"></i> Limpiar Filtros
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Información de Resultados -->
                    {% if search_query or usuario_filtro or fecha_desde or fecha_hasta or monto_minimo %}
                    <div class="alert alert-info mb-4" role="alert">
                        <i class="bi bi-info-circle"></i> Se muestran <strong>{{ ventas|length }}</strong> venta(s) de <strong>{{ ventas_total|length }}</strong> total(es)
                        {% if search_query %}<br><small>• Búsqueda: "{{ search_query }}"</small>{% endif %}
                        {% if usuario_filtro %}<br><small>• Usuario: {{ usuario_filtro }}</small>{% endif %}
                        {% if monto_minimo %}<br><small>• Monto mínimo: ₲{{ monto_minimo }}</small>{% endif %}
                        {% if fecha_desde %}<br><small>• Desde: {{ fecha_desde }}</small>{% endif %}
                        {% if fecha_hasta %}<br><small>• Hasta: {{ fecha_hasta }}</small>{% endif %}
                    </div>
                    {% endif %}

                    <!-- Tabla -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Usuario</th>
                                    <th>Total (₲)</th>
                                    <th>Productos</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if ventas %}
                                {% for venta in ventas %}
                                <tr>
                                    <td><strong>#{{ venta["id"] }}</strong></td>
                                    <td>
                                        <small>{{ venta["fecha"] }}</small>
                                    </td>
                                    <td>{{ venta["username"] if venta["username"] else "-" }}</td>
                                    <td>
                                        <span class="badge {% if venta["total"] >= 1000000 %}bg-success{% elif venta["total"] >= 500000 %}bg-info{% else %}bg-secondary{% endif %}">
                                            ₲{{ venta["total"]|int }}
                                        </span>
                                    </td>
                                    <td>
                                        <!-- Botón que abre modal con detalle de productos -->
                                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#modal-productos-{{ venta["id"] }}">
                                            Ver Productos
                                        </button>

                                        <!-- Modal por venta -->
                                        <div class="modal fade" id="modal-productos-{{ venta["id"] }}" tabindex="-1" aria-labelledby="modalLabel-{{ venta["id"] }}" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="modalLabel-{{ venta["id"] }}">Detalle de Venta #{{ venta["id"] }}</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="table-responsive">
                                                            <table class="table table-sm table-borderless mb-0">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Producto</th>
                                                                        <th class="text-center">Cantidad</th>
                                                                        <th class="text-end">Subtotal (₲)</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {% for detalle in obtener_detalle_venta(venta["id"]) %}
                                                                    <tr>
                                                                        <td>{{ detalle["nombre"] }}</td>
                                                                        <td class="text-center">{{ detalle["cantidad"] }}</td>
                                                                        <td class="text-end">₲{{ detalle["subtotal"]|int }}</td>
                                                                    </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                        <p class="mt-2">No se encontraron ventas que coincidan con los filtros aplicados.</p>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación -->
                    {% if total_pages and total_pages > 1 %}
                    <nav aria-label="Paginación" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('registros.listado_registros') }}{% if query_string %}?{{ query_string }}&page={{ page-1 }}{% else %}?page={{ page-1 }}{% endif %}">Anterior</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                            {% endif %}

                            {% for p in range(1, total_pages+1) %}
                            <li class="page-item {% if p == page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('registros.listado_registros') }}{% if query_string %}?{{ query_string }}&page={{ p }}{% else %}?page={{ p }}{% endif %}">{{ p }}</a>
                            </li>
                            {% endfor %}

                            {% if page < total_pages %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('registros.listado_registros') }}{% if query_string %}?{{ query_string }}&page={{ page+1 }}{% else %}?page={{ page+1 }}{% endif %}">Siguiente</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuración común para gráficos
    Chart.defaults.font.family = 'Roboto, sans-serif';
    Chart.defaults.plugins.legend.display = true;

    // Datos para gráficos
    const ventasMensuales = {{ ventas_mensuales|tojson }};
    const ventasSemanales = {{ ventas_semanales|tojson }};
    const topProductos = {{ top_productos|tojson }};

    // Gráfico de Ventas por Mes
    const ctxMensual = document.getElementById('ventasMensualesChart').getContext('2d');
    new Chart(ctxMensual, {
        type: 'line',
        data: {
            labels: ventasMensuales.map(item => {
                const [year, month] = item.mes.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
            }),
            datasets: [{
                label: 'Cantidad de Ventas',
                data: ventasMensuales.map(item => item.cantidad),
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                yAxisID: 'y',
                tension: 0.4
            }, {
                label: 'Total Recaudado (₲)',
                data: ventasMensuales.map(item => item.total),
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                yAxisID: 'y1',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Tendencia de Ventas Mensuales'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 1) {
                                return context.dataset.label + ': ₲' + context.parsed.y.toLocaleString();
                            }
                            return context.dataset.label + ': ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Cantidad de Ventas'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Total Recaudado (₲)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return '₲' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Gráfico de Ventas por Semana
    const ctxSemanal = document.getElementById('ventasSemanalesChart').getContext('2d');
    new Chart(ctxSemanal, {
        type: 'bar',
        data: {
            labels: ventasSemanales.map(item => {
                const [year, week] = item.semana.split('-W');
                return `Sem ${week}/${year.slice(-2)}`;
            }),
            datasets: [{
                label: 'Ventas por Semana',
                data: ventasSemanales.map(item => item.cantidad),
                backgroundColor: 'rgba(13, 202, 240, 0.8)',
                borderColor: 'rgb(13, 202, 240)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Ventas por Semana (Últimas 8 semanas)'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Cantidad de Ventas'
                    }
                }
            }
        }
    });

    // Gráfico de Productos Más Vendidos
    const ctxProductos = document.getElementById('topProductosChart').getContext('2d');
    new Chart(ctxProductos, {
        type: 'doughnut',
        data: {
            labels: topProductos.map(item => item.nombre.length > 20 ? item.nombre.substring(0, 20) + '...' : item.nombre),
            datasets: [{
                data: topProductos.map(item => item.cantidad_vendida),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Productos Más Vendidos'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const item = topProductos[context.dataIndex];
                            return [
                                `Producto: ${item.nombre}`,
                                `Cantidad: ${item.cantidad_vendida}`,
                                `Total: ₲${item.ventas_total.toLocaleString()}`
                            ];
                        }
                    }
                }
            }
        }
    });
});
</script>

{% endblock %}
